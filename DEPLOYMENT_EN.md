# ðŸš€ Deployment Guide - Legal Case Law AI Database

## Table of Contents

1. [Replit Deployment](#replit-deployment)
2. [VPS Deployment](#vps-deployment)
3. [Production Configuration](#production-configuration)
4. [Security](#security)
5. [Maintenance](#maintenance)
6. [Troubleshooting](#troubleshooting)

## Replit Deployment

### Automatic Configuration

The application is ready for Replit deployment.

#### Step 1: Environment Variables

Configure the following Replit secrets:

1. **ENCRYPTION_KEY** (Required)
```bash
python -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())'
```

2. **OPENROUTER_API_KEY** (Required)
- Get it from https://openrouter.ai/
- "Keys" section â†’ "Create Key"

3. **SESSION_SECRET** (Auto-generated by Replit)

4. **DATABASE_URL** (Auto-generated by Replit)

#### Step 2: Publish

1. Click the **"Deploy"** button in Replit
2. Select deployment mode:
   - **Autoscale**: Recommended (economical, auto-scales)
   - **Reserved VM**: If need to always run
3. Configure custom domain (optional)
4. Click **"Deploy"**

## VPS Deployment

### Server Requirements

- **OS**: Ubuntu 20.04 LTS or 22.04 LTS
- **RAM**: Minimum 2 GB (4 GB recommended)
- **CPU**: Minimum 1 vCPU (2 vCPU recommended)
- **Storage**: Minimum 20 GB
- **Access**: SSH with sudo

### Quick Install (Automatic Script)

```bash
# Download deployment script
wget https://your-repo/deploy_vps.sh

# Make executable
chmod +x deploy_vps.sh

# Execute (as root or with sudo)
sudo ./deploy_vps.sh
```

The script automatically installs:
- Python 3.11
- PostgreSQL 14
- Nginx
- Gunicorn
- Certbot (Let's Encrypt SSL)

### Manual Installation

#### 1. System Update

```bash
sudo apt update && sudo apt upgrade -y
```

#### 2. Install Python 3.11

```bash
sudo apt install -y python3.11 python3.11-venv python3-pip
```

#### 3. Install PostgreSQL

```bash
sudo apt install -y postgresql postgresql-contrib

# Create user and database
sudo -u postgres psql
```

```sql
CREATE USER jurisprudence WITH PASSWORD 'your_secure_password';
CREATE DATABASE jurisprudence_db OWNER jurisprudence;
GRANT ALL PRIVILEGES ON DATABASE jurisprudence_db TO jurisprudence;
\q
```

#### 4. Install Nginx

```bash
sudo apt install -y nginx
```

#### 5. Clone Project

```bash
cd /var/www
sudo git clone https://github.com/your-username/jurisprudence-platform.git
cd jurisprudence-platform
```

#### 6. Create Virtual Environment

```bash
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

#### 7. Configure Environment Variables

```bash
sudo nano /etc/environment
```

Add:
```
DATABASE_URL="postgresql://jurisprudence:your_password@localhost/jurisprudence_db"
SESSION_SECRET="your_random_secret_key_32_characters"
ENCRYPTION_KEY="your_generated_fernet_key"
OPENROUTER_API_KEY="your_openrouter_key"
```

Reload:
```bash
source /etc/environment
```

#### 8. Initialize Database

```bash
python -c "from backend.app import app, db; app.app_context().push(); db.create_all()"
```

#### 9. Configure Gunicorn (Systemd Service)

```bash
sudo nano /etc/systemd/system/jurisprudence.service
```

Content:
```ini
[Unit]
Description=Jurisprudence AI Gunicorn Service
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
RuntimeDirectory=gunicorn
WorkingDirectory=/var/www/jurisprudence-platform
Environment="PATH=/var/www/jurisprudence-platform/venv/bin"
Environment="DATABASE_URL=postgresql://jurisprudence:PASSWORD@localhost/jurisprudence_db"
Environment="SESSION_SECRET=YOUR_SESSION_SECRET"
Environment="ENCRYPTION_KEY=YOUR_ENCRYPTION_KEY"
Environment="OPENROUTER_API_KEY=YOUR_OPENROUTER_KEY"
ExecStart=/var/www/jurisprudence-platform/venv/bin/gunicorn \
          --workers 4 \
          --threads 2 \
          --timeout 120 \
          --bind unix:/run/gunicorn/jurisprudence.sock \
          --access-logfile /var/log/gunicorn/access.log \
          --error-logfile /var/log/gunicorn/error.log \
          main:app
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

Create log directories:
```bash
sudo mkdir -p /var/log/gunicorn
sudo chown www-data:www-data /var/log/gunicorn
```

Enable and start:
```bash
sudo systemctl daemon-reload
sudo systemctl enable jurisprudence
sudo systemctl start jurisprudence
sudo systemctl status jurisprudence
```

#### 10. Configure Nginx

```bash
sudo nano /etc/nginx/sites-available/jurisprudence
```

Content:
```nginx
upstream jurisprudence_app {
    server unix:/run/gunicorn/jurisprudence.sock fail_timeout=0;
}

server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    client_max_body_size 100M;

    location / {
        proxy_pass http://jurisprudence_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_buffering off;
    }

    location /static/ {
        alias /var/www/jurisprudence-platform/frontend/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /uploads/ {
        alias /var/www/jurisprudence-platform/uploads/;
        internal;
    }
}
```

Enable site:
```bash
sudo ln -s /etc/nginx/sites-available/jurisprudence /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 11. Configure SSL with Let's Encrypt

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

Auto-renewal:
```bash
sudo certbot renew --dry-run
```

## Production Configuration

### Production Environment Variables

```bash
# Database
DATABASE_URL="postgresql://user:pass@localhost/db"

# Security
SESSION_SECRET="random_key_64_characters_minimum"
ENCRYPTION_KEY="fernet_key_32_bytes_base64"

# External API
OPENROUTER_API_KEY="sk-or-v1-..."

# Production mode
FLASK_ENV="production"
DEBUG="False"
```

### Gunicorn - Optimal Configuration

```bash
# Number of workers
workers = (2 x CPU_count) + 1

# Example for 2 CPUs
gunicorn --workers 5 --threads 2 --timeout 120 main:app
```

### PostgreSQL - Optimizations

```sql
-- Increase max connections
ALTER SYSTEM SET max_connections = 100;

-- Optimize memory
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';

-- Restart PostgreSQL
sudo systemctl restart postgresql
```

## Security

### Security Checklist

- [ ] **Change default admin password**
```python
# Via Python shell or admin route
admin.password_hash = bcrypt.generate_password_hash('NewSecurePassword').decode('utf-8')
db.session.commit()
```

- [ ] **HTTPS enabled** (Let's Encrypt)
- [ ] **Firewall configured** (UFW)
```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

- [ ] **PostgreSQL accessible locally only**
- [ ] **Secrets in environment variables** (not in code)
- [ ] **Logs configured** and monitored
- [ ] **Automatic backups** enabled

## Maintenance

### Automatic Backups

#### PostgreSQL Backup Script

```bash
sudo nano /usr/local/bin/backup-jurisprudence.sh
```

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/jurisprudence"
DB_NAME="jurisprudence_db"

mkdir -p $BACKUP_DIR

# Database backup
pg_dump $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Uploaded files backup
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/www/jurisprudence-platform/uploads/

# Keep only last 30 backups
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +30 -delete
find $BACKUP_DIR -name "uploads_*.tar.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
```

Make executable:
```bash
sudo chmod +x /usr/local/bin/backup-jurisprudence.sh
```

#### Cron for Daily Backups

```bash
sudo crontab -e
```

Add:
```
0 2 * * * /usr/local/bin/backup-jurisprudence.sh >> /var/log/backup-jurisprudence.log 2>&1
```

### Monitoring

#### Important Logs

```bash
# Application logs
sudo journalctl -u jurisprudence -f

# Nginx logs
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# Gunicorn logs
sudo tail -f /var/log/gunicorn/access.log
sudo tail -f /var/log/gunicorn/error.log
```

### Updates

#### Application Update

```bash
cd /var/www/jurisprudence-platform
git pull origin main
source venv/bin/activate
pip install -r requirements.txt --upgrade
sudo systemctl restart jurisprudence
```

## Troubleshooting

### Problem: Application won't start

```bash
# Check service status
sudo systemctl status jurisprudence

# View complete logs
sudo journalctl -u jurisprudence -n 100 --no-pager

# Check permissions
sudo chown -R www-data:www-data /var/www/jurisprudence-platform
```

### Problem: 502 Bad Gateway

```bash
# Check Gunicorn is running
sudo systemctl status jurisprudence

# Check socket
ls -la /run/gunicorn/jurisprudence.sock

# Check Nginx logs
sudo tail -f /var/log/nginx/error.log
```

### Problem: Database inaccessible

```bash
# Check PostgreSQL
sudo systemctl status postgresql

# Test connection
psql -U jurisprudence -d jurisprudence_db -h localhost
```

## Support

For deployment assistance:
- Technical documentation: TECHNICAL_DOCUMENTATION_EN.md
- Email: support@jurisprudence-platform.com
- GitHub Issues: https://github.com/your-repo/issues

---

**Last updated**: 2024
**Version**: 1.1
